
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PO Wise YY Validation</title>
        <link rel="icon" href="free-30-instagram-stories-icons46_122593.ico" type="image/ico">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            min-height: 100vh;
            color: #333;
            position: relative;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.8rem;
            font-weight: 700;
            color: #059669;
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard-title {
            text-align: center;
            margin-bottom: 3rem;
        }

        .dashboard-title h1 {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }
        
.dashboard-title h1:hover {
    background: none;
    -webkit-text-fill-color: #ffffff;
    color: #ffffff;
    transition: 0.3s ease;
    cursor: pointer;
}


        .section-title {
            text-align: center;
            margin: 3rem 0 1.5rem 0;
            color: white;
            font-size: 2rem;
            font-weight: 700;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 2rem;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .file-input {
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            width: 100%;
        }

        .process-btn, .download-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            margin: 10px 5px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
            font-weight: 600;
        }

        .download-btn {
            background-color: #27ae60;
        }

        .validation-btn {
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            margin: 10px 5px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
            font-weight: 600;
        }

        .validation-btn:hover {
            background-color: #e67e22;
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            font-weight: 500;
        }

        .success {
            background-color: #d5f4e6;
            color: #27ae60;
            border: 1px solid #a3e4bc;
        }

        .error {
            background-color: #fadbd8;
            color: #e74c3c;
            border: 1px solid #f5b7b1;
        }

        .info {
            background-color: #d6eaf8;
            color: #3498db;
            border: 1px solid #aed6f1;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .validation-section {
            margin-top: 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #34495e;
            color: white;
            font-weight: 600;
        }

        .section-divider {
            border: none;
            height: 2px;
            background: linear-gradient(90deg, transparent, #10b981, transparent);
            margin: 2rem 0;
        }

        .match {
            color: #27ae60;
            font-weight: bold;
        }

        .mismatch {
            color: #e74c3c;
            font-weight: bold;
        }

        .error-status {
            color: #e74c3c;
            font-weight: bold;
            background-color: #fadbd8;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .found-oc {
            background-color: #FFA500 !important;
            color: white !important;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .help-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .help-button:hover {
            background-color: #2980b9;
            transform: scale(1.1);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 15px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }

        .close-modal:hover {
            color: #e74c3c;
        }

        .file-structure {
            background: #e8f4fd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .tab-info {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
        }

        ul {
            padding-inline-start: 30px;
        }

        @media (max-width: 1024px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .help-button {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-industry"></i>
                <span>PO Wise YY Validation</span>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="dashboard-title">
            <h1>Validate PO Wise YY with MRL Docket</h1>
            <p>Upload your PO Wise YY and MRL Docket Excel files to validate YY and wastage values</p>
            <p><strong>MRL Docket file should contain two tabs: Material Details and Order Details</strong></p>
        </div>

        <!-- SECTION 1: FILE UPLOAD -->
        <div class="section-title">Section 1: Upload Files</div>
        
        <div class="two-column">
            <div class="upload-section">
                <h2>Step 1: Upload PO Wise YY File</h2>
                <p>Upload the Excel file containing PO Wise YY data</p>
                <input type="file" id="poYyFile" class="file-input" accept=".xlsx, .xls">
                <div id="poYyInfo" class="file-info"></div>
            </div>

            <div class="upload-section">
                <h2>Step 2: Upload MRL Docket File</h2>
                <p>Upload the Excel file containing MRL Docket with TWO tabs:</p>
                <div class="file-structure">
                    <div class="tab-info">
                        <h4><i class="fas fa-table"></i> Tab 1: Material Details</h4>
                        <p>Contains material consumption data with columns:</p>
                        <ul>
                            <li><strong>Summary OC</strong> (required)</li>
                            <li><strong>Article Name(Code)</strong> (required)</li>
                            <li><strong>Article Color Code</strong> (required)</li>
                            <li><strong>Consumption</strong> (required)</li>
                            <li><strong>Wastage %</strong> (required)</li>
                            <li>Other columns (optional)</li>
                        </ul>
                    </div>
                    <div class="tab-info">
                        <h4><i class="fas fa-table"></i> Tab 2: Order Details</h4>
                        <p>Contains order reference mapping with columns:</p>
                        <ul>
                            <li><strong>Buyer Order Ref</strong> (required)</li>
                            <li><strong>Summary OC / Main OC</strong> (required)</li>
                            <li>Other columns (optional)</li>
                        </ul>
                    </div>
                </div>
                <input type="file" id="mrlDocketFile" class="file-input" accept=".xlsx, .xls">
                <div id="mrlDocketInfo" class="file-info"></div>
            </div>
        </div>
        
        <div style="text-align: center;">
            <button id="validateBtn" class="validation-btn" disabled>Validate Data</button>
            <button id="downloadReportBtn" class="download-btn" disabled>Download Validation Report</button>
        </div>
        
        <div id="status" class="status"></div>

        <!-- SECTION 2: VALIDATION RESULTS -->
        <div class="section-title">Section 2: Validation Results</div>

        <!-- Statistics Cards -->
        <div class="stats-grid" id="statsSection" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="totalRecords">0</div>
                <div class="stat-label">Total Records</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="yyMatches">0</div>
                <div class="stat-label">YY Matches</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="yyMismatches">0</div>
                <div class="stat-label">YY Mismatches</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="wastageMatches">0</div>
                <div class="stat-label">Wastage Matches</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="wastageMismatches">0</div>
                <div class="stat-label">Wastage Mismatches</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="invalidVPO">0</div>
                <div class="stat-label">Invalid VPO Format</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="foundOC">0</div>
                <div class="stat-label">Found OC Numbers</div>
            </div>
        </div>

        <!-- Validation Results Table -->
        <div class="validation-section" id="validationSection" style="display: none;">
            <h2>YY & Wastage Comparison Results</h2>
            <div style="overflow-x: auto;">
                <table id="validationTable">
                    <thead>
                        <tr>
                            <th>Summary Buyer Order Ref CPO</th>
                            <th>WFX Code</th>
                            <th>RM Color Code</th>
                            <th>PO Wise YY</th>
                            <th>MRL YY</th>
                            <th>YY Match</th>
                            <th>PO Wise Wastage</th>
                            <th>MRL Wastage</th>
                            <th>Wastage Match</th>
                            <th>Status</th>
                            <th>Original VPO</th>
                            <th>Lookup CPO</th>
                        </tr>
                    </thead>
                    <tbody id="validationTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Help Button -->
    <button class="help-button" onclick="openHelpModal()">
        <i class="fas fa-question"></i>
    </button>

    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeHelpModal()">&times;</button>
            <h2><i class="fas fa-info-circle"></i> PO Wise YY Validation - Complete Guide</h2>
            
            <div style="margin-top: 20px;">
                <h3>1. Excel File Requirements</h3>
                
                <div class="two-column">
                    <div>
                        <h4>PO Wise YY File Structure</h4>
                        <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <p><strong>Required Columns:</strong></p>
                            <ul>
                                <li><strong>Delivery Buyer Order Ref VPO</strong> - VPO reference number</li>
                                <li><strong>Summary Buyer Order Ref CPO</strong> - CPO reference number</li>
                                <li><strong>WFX Code</strong> - Article/WFX identification code</li>
                                <li><strong>RM Color Code</strong> - Raw material color code</li>
                                <li><strong>Bulk YY</strong> - Yarn Yield value from PO</li>
                                <li><strong>Bulk Wastage</strong> - Wastage percentage from PO</li>
                            </ul>
                            <p><em>Note: Column names may vary slightly. The tool will automatically detect similar column names.</em></p>
                        </div>
                    </div>
                    <div>
                        <h4>MRL Docket File Structure</h4>
                        <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <p><strong>Material Details Tab (Required):</strong></p>
                            <ul>
                                <li><strong>Summary OC</strong> - Order confirmation number</li>
                                <li><strong>Article Name(Code)</strong> - Article identification</li>
                                <li><strong>Article Color Code</strong> - Color identification</li>
                                <li><strong>Consumption</strong> - YY value from MRL</li>
                                <li><strong>Wastage %</strong> - Wastage percentage from MRL</li>
                            </ul>
                            <p><strong>Order Details Tab (Optional but recommended):</strong></p>
                            <ul>
                                <li><strong>Buyer Order Ref</strong> - CPO reference</li>
                                <li><strong>Summary OC / Main OC</strong> - OC number mapping</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <h3>2. YY Value Extraction Logic</h3>
                
                <div class="two-column">
                    <div>
                        <h4>PO Wise YY File Extraction</h4>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <p><strong>Column Names Searched:</strong></p>
                            <ul>
                                <li>"Bulk YY"</li>
                                <li>"YY"</li>
                                <li>"Yarn Yield"</li>
                            </ul>
                            <p><strong>Data Conversion:</strong></p>
                            <ul>
                                <li>Percentages (82.61% → 0.8261)</li>
                                <li>Text numbers ("0.8261" → 0.8261)</li>
                                <li>Decimal numbers (0.8261 → 0.8261)</li>
                                <li>Handles comma separators</li>
                            </ul>
                        </div>
                    </div>
                    <div>
                        <h4>MRL Docket File Extraction</h4>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <p><strong>Column Names Searched:</strong></p>
                            <ul>
                                <li>"Consumption"</li>
                                <li>"YY"</li>
                                <li>"Yarn Yield"</li>
                            </ul>
                            <p><strong>Data Conversion:</strong></p>
                            <ul>
                                <li>Percentages (82.61% → 0.8261)</li>
                                <li>Text numbers ("0.8261" → 0.8261)</li>
                                <li>Decimal numbers (0.8261 → 0.8261)</li>
                                <li>Handles comma separators</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <h3>3. OC Number Finding Logic</h3>
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4>Step-by-Step OC Identification Process:</h4>
                    <ol>
                        <li><strong>VPO Validation:</strong> Check if VPO starts with "INQDCL"</li>
                        <li><strong>Direct Match:</strong> Use VPO as OC if valid format</li>
                        <li><strong>CPO Lookup:</strong> If VPO invalid, use CPO to find OC in Order Details tab</li>
                        <li><strong>Mapping:</strong> Match CPO with "Buyer Order Ref" to get "Summary OC"</li>
                        <li><strong>Fallback:</strong> If no match found, mark as "Cannot identify summary OC"</li>
                    </ol>
                    <p><strong>Note:</strong> Found OC numbers are highlighted in orange in the results table.</p>
                </div>

                <h3>4. YY Checking Logic</h3>
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4>YY Comparison Process:</h4>
                    <ol>
                        <li><strong>Extract Values:</strong> Get YY values from both files</li>
                        <li><strong>Format Conversion:</strong> Convert all values to 4 decimal places</li>
                        <li><strong>Exact Comparison:</strong> Compare values with 4 decimal precision</li>
                        <li><strong>Match Determination:</strong> Mark as "Match" if values are exactly equal</li>
                    </ol>
                    <p><strong>Wastage Comparison:</strong> Similar process but with 2 decimal precision</p>
                </div>

                <h3>5. Common YY Extraction Issues</h3>
                <div style="background: #f8d7da; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4><i class="fas fa-exclamation-triangle"></i> Why YY Values Might Be Missing or Incorrect:</h4>
                    <ul>
                        <li><strong>Column Name Mismatch:</strong> Different column names in your files</li>
                        <li><strong>Data Format Issues:</strong> Text instead of numbers, percentages, etc.</li>
                        <li><strong>Empty Cells:</strong> Blank or null values in YY columns</li>
                        <li><strong>Decimal Separators:</strong> Commas vs periods in numbers</li>
                        <li><strong>File Structure:</strong> Missing required tabs or columns</li>
                        <li><strong>Encoding Issues:</strong> Special characters in column names</li>
                    </ul>
                </div>

                <h3>6. Troubleshooting Steps</h3>
                <div class="two-column">
                    <div>
                        <h4>1. Check Column Names</h4>
                        <ul>
                            <li>Verify your YY column names match expected names</li>
                            <li>Look for variations like "BulkYY", "YY%", etc.</li>
                            <li>Check for extra spaces or special characters</li>
                        </ul>
                    </div>
                    <div>
                        <h4>2. Verify Data Formats</h4>
                        <ul>
                            <li>Ensure YY values are numbers</li>
                            <li>Check for percentage signs (%)</li>
                            <li>Look for text values that should be numbers</li>
                        </ul>
                    </div>
                    <div>
                        <h4>3. Validate File Structure</h4>
                        <ul>
                            <li>MRL Docket must have Material Details tab</li>
                            <li>Order Details tab is optional but recommended</li>
                            <li>Check for empty rows or missing data</li>
                        </ul>
                    </div>
                    <div>
                        <h4>4. OC Number Issues</h4>
                        <ul>
                            <li>Ensure VPO starts with "INQDCL"</li>
                            <li>Verify CPO values in Order Details mapping</li>
                            <li>Check for exact matches in Order Details</li>
                        </ul>
                    </div>
                </div>

                <h3>7. Supported YY Formats</h3>
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4>The tool can handle these YY value formats:</h4>
                    <ul>
                        <li><strong>Decimal:</strong> 0.8261, 1.2500, 0.5000</li>
                        <li><strong>Percentage:</strong> 82.61%, 125%, 50.00%</li>
                        <li><strong>Text Numbers:</strong> "0.8261", "1.25", "0.5"</li>
                        <li><strong>Mixed:</strong> 0.8261%, 1.25 (auto-converted)</li>
                        <li><strong>Comma Decimal:</strong> 0,8261 (European format)</li>
                    </ul>
                </div>

                <h3>8. Results Table Field Descriptions</h3>
                <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4>YY & Wastage Comparison Results Table Columns:</h4>
                    <ul>
                        <li><strong>Summary Buyer Order Ref CPO:</strong> Final OC number used for matching (orange highlight indicates found via CPO lookup)</li>
                        <li><strong>WFX Code:</strong> Article identification code from PO file</li>
                        <li><strong>RM Color Code:</strong> Color code from PO file</li>
                        <li><strong>PO Wise YY:</strong> Yarn Yield value from PO file (4 decimal places)</li>
                        <li><strong>MRL YY:</strong> Yarn Yield value from MRL file (4 decimal places)</li>
                        <li><strong>YY Match:</strong> Comparison result (Match/Mismatch)</li>
                        <li><strong>PO Wise Wastage:</strong> Wastage percentage from PO file (2 decimal places)</li>
                        <li><strong>MRL Wastage:</strong> Wastage percentage from MRL file (2 decimal places)</li>
                        <li><strong>Wastage Match:</strong> Comparison result (Match/Mismatch)</li>
                        <li><strong>Status:</strong> Overall validation status</li>
                        <li><strong>Original VPO:</strong> Original VPO value from PO file</li>
                        <li><strong>Lookup CPO:</strong> CPO value used for OC lookup (if applicable)</li>
                    </ul>
                </div>

                <h3>9. Color Coding in Results</h3>
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4>Row Color Indicators:</h4>
                    <ul>
                        <li><strong style="color: #27ae60;">Green:</strong> Both YY and Wastage match</li>
                        <li><strong style="color: #ffc107;">Yellow:</strong> Either YY or Wastage matches (partial match)</li>
                        <li><strong style="color: #e74c3c;">Red:</strong> Neither YY nor Wastage matches</li>
                        <li><strong style="color: #fd7e14;">Orange:</strong> Found OC number via CPO lookup</li>
                        <li><strong style="color: #d6eaf8;">Light Blue:</strong> Invalid VPO format</li>
                    </ul>
                </div>

                <h3>10. Validation Process Flow</h3>
                <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4>Complete Validation Workflow:</h4>
                    <ol>
                        <li><strong>File Upload:</strong> Upload PO Wise YY and MRL Docket files</li>
                        <li><strong>Data Extraction:</strong> Extract YY and wastage values from both files</li>
                        <li><strong>OC Identification:</strong> Find correct OC numbers using VPO/CPO</li>
                        <li><strong>Data Matching:</strong> Match records based on OC, WFX Code, and Color Code</li>
                        <li><strong>Value Comparison:</strong> Compare YY and wastage values with precision</li>
                        <li><strong>Results Generation:</strong> Create validation results with color coding</li>
                        <li><strong>Report Download:</strong> Export results to Excel with formatting</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let poYyData = [];
        let mrlMaterialData = [];
        let mrlOrderDetailsData = [];
        let validationResults = [];
        let orderDetailsMap = new Map();

        // DOM elements
        const poYyFileInput = document.getElementById('poYyFile');
        const mrlDocketFileInput = document.getElementById('mrlDocketFile');
        const validateBtn = document.getElementById('validateBtn');
        const downloadReportBtn = document.getElementById('downloadReportBtn');
        const statusDiv = document.getElementById('status');
        const statsSection = document.getElementById('statsSection');
        const validationSection = document.getElementById('validationSection');
        const validationTableBody = document.getElementById('validationTableBody');
        const helpModal = document.getElementById('helpModal');

        // Event listeners
        poYyFileInput.addEventListener('change', handlePoYyFile);
        mrlDocketFileInput.addEventListener('change', handleMrlDocketFile);
        validateBtn.addEventListener('click', validateData);
        downloadReportBtn.addEventListener('click', downloadValidationReport);

        // Help modal functions
        function openHelpModal() {
            helpModal.style.display = 'flex';
        }

        function closeHelpModal() {
            helpModal.style.display = 'none';
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === helpModal) {
                closeHelpModal();
            }
        });

        // File handling functions
        function handlePoYyFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    poYyData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    updateValidateButtonState();
                    showStatus('PO Wise YY file loaded successfully!', 'success');
                } catch (error) {
                    console.error('Error reading PO Wise YY file:', error);
                    showStatus('Error reading PO Wise YY file. Please check the format.', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function handleMrlDocketFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Find Material Details and Order Details tabs
                    let materialSheet = null;
                    let orderDetailsSheet = null;
                    
                    // Try to find tabs by name first
                    for (let sheetName of workbook.SheetNames) {
                        const lowerName = sheetName.toLowerCase();
                        if (lowerName.includes('material') || lowerName.includes('consumption')) {
                            materialSheet = workbook.Sheets[sheetName];
                        } else if (lowerName.includes('order') || lowerName.includes('reference')) {
                            orderDetailsSheet = workbook.Sheets[sheetName];
                        }
                    }
                    
                    // Fallback to first two sheets if specific names not found
                    if (!materialSheet && workbook.SheetNames.length >= 1) {
                        materialSheet = workbook.Sheets[workbook.SheetNames[0]];
                    }
                    
                    if (!orderDetailsSheet && workbook.SheetNames.length >= 2) {
                        orderDetailsSheet = workbook.Sheets[workbook.SheetNames[1]];
                    }
                    
                    if (!materialSheet) {
                        showStatus('MRL Docket file must contain at least one tab for Material Details.', 'error');
                        return;
                    }
                    
                    // Extract data from both tabs
                    mrlMaterialData = XLSX.utils.sheet_to_json(materialSheet, { header: 1 });
                    
                    if (orderDetailsSheet) {
                        mrlOrderDetailsData = XLSX.utils.sheet_to_json(orderDetailsSheet, { header: 1 });
                        
                        // Process Order Details to build mapping
                        processOrderDetailsData();
                    } else {
                        orderDetailsMap.clear();
                    }
                    
                    updateValidateButtonState();
                    showStatus('MRL Docket file loaded successfully!' + (orderDetailsSheet ? ' Found both tabs.' : ' Found Material Details tab only.'), 'success');
                } catch (error) {
                    console.error('Error reading MRL Docket file:', error);
                    showStatus('Error reading MRL Docket file. Please check the format.', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processOrderDetailsData() {
            orderDetailsMap.clear();
            
            const headers = mrlOrderDetailsData[0];
            if (!headers) {
                return;
            }
            
            // Find Buyer Order Ref and Summary OC columns with flexible matching
            const buyerOrderRefIndex = findColumnIndex(headers, ['buyer order ref', 'buyerorderref', 'order ref', 'purchase order']);
            const summaryOcIndex = findColumnIndex(headers, ['summary oc', 'main oc', 'summaryoc', 'mainoc', 'inqdcl']);
            
            if (buyerOrderRefIndex === -1 || summaryOcIndex === -1) {
                showStatus('Order Details tab missing required columns (Buyer Order Ref and Summary OC/Main OC).', 'error');
                return;
            }

            // Process order details rows
            for (let i = 1; i < mrlOrderDetailsData.length; i++) {
                const row = mrlOrderDetailsData[i];
                if (!row || row.length <= Math.max(buyerOrderRefIndex, summaryOcIndex)) continue;
                
                const buyerOrderRef = (row[buyerOrderRefIndex] || '').toString().trim();
                const summaryOc = (row[summaryOcIndex] || '').toString().trim();
                
                if (buyerOrderRef && summaryOc) {
                    orderDetailsMap.set(buyerOrderRef, summaryOc);
                }
            }
        }

        // Helper function to find column index with flexible matching
        function findColumnIndex(headers, possibleNames) {
            for (let name of possibleNames) {
                const index = headers.findIndex(h => 
                    h && h.toString().toLowerCase().replace(/\s+/g, '').includes(name.toLowerCase().replace(/\s+/g, ''))
                );
                if (index !== -1) return index;
            }
            return -1;
        }

        // Improved function to extract YY values with better error handling
        function extractYYValue(rawValue, source = 'unknown') {
            if (rawValue === null || rawValue === undefined || rawValue === '') {
                return 0;
            }
            
            let valueStr = String(rawValue).trim();
            
            // Handle percentage values
            if (valueStr.includes('%')) {
                valueStr = valueStr.replace('%', '');
            }
            
            // Handle commas as decimal separators
            if (valueStr.includes(',')) {
                valueStr = valueStr.replace(',', '.');
            }
            
            // Convert to number
            let numericValue = parseFloat(valueStr);
            
            // If it's a percentage that was > 1, convert to decimal
            if (numericValue > 1 && source.includes('percentage')) {
                numericValue = numericValue / 100;
            }
            
            if (isNaN(numericValue)) {
                return 0;
            }
            
            return numericValue;
        }

        function updateValidateButtonState() {
            validateBtn.disabled = !(poYyData.length > 0 && mrlMaterialData.length > 0);
        }

        // WFX Code extraction function
        function extractWFXCode(articleName) {
            if (!articleName) return '';
            
            // Look for the last occurrence of text inside parentheses
            const matches = articleName.match(/\(([^)]+)\)[^()]*$/);
            if (matches && matches[1]) {
                return matches[1];
            }
            
            return '';
        }

        // VPO Validation function
        function validateVPOFormat(vpoValue) {
            if (!vpoValue) return false;
            const vpoStr = String(vpoValue).trim();
            return vpoStr.startsWith('INQDCL');
        }

        // Function to find OC number from Order Details using CPO
        function findOCFromOrderDetails(cpoValue) {
            if (!cpoValue) return null;
            
            const result = orderDetailsMap.get(cpoValue.trim());
            
            return result || null;
        }

        // Function to format YY values to 4 decimal places
        function formatYYValue(value) {
            if (isNaN(value) || value === null || value === undefined) return '0.0000';
            return parseFloat(value).toFixed(4);
        }

        // Function to compare YY values with exact 4 decimal precision
        function compareYYValues(value1, value2) {
            const val1 = parseFloat(value1).toFixed(4);
            const val2 = parseFloat(value2).toFixed(4);
            return val1 === val2;
        }

        // Function to compare wastage values with exact 2 decimal precision
        function compareWastageValues(value1, value2) {
            const val1 = parseFloat(value1).toFixed(2);
            const val2 = parseFloat(value2).toFixed(2);
            return val1 === val2;
        }

        // Function to determine row color based on validation status
        function getRowColor(result) {
            if (result.foundOC) {
                return "FFA500"; // Orange for found OC numbers
            } else if (result.status === 'Cannot identify summary OC' && !result.foundOC) {
                return "D6EAF8"; // Light Blue for invalid VPO format
            } else if (result.yyMatch && result.wastageMatch) {
                return "C6EFCE"; // Light Green for complete match
            } else if (result.yyMatch || result.wastageMatch) {
                return "FFEB9C"; // Light Yellow for partial match
            } else {
                return "FFC7CE"; // Light Red for complete mismatch
            }
        }

        // Main validation function
        function validateData() {
            if (poYyData.length === 0 || mrlMaterialData.length === 0) {
                showStatus('Please upload both PO Wise YY and MRL Docket files before validating.', 'error');
                return;
            }

            try {
                // Map columns for PO YY file
                const poYyHeaders = poYyData[0];
                const mrlHeaders = mrlMaterialData[0];
                
                // Find required columns in PO YY with flexible matching
                const vpoIndex = findColumnIndex(poYyHeaders, ['delivery buyer order ref vpo', 'vpo']);
                const cpoIndex = findColumnIndex(poYyHeaders, ['summary buyer order ref cpo', 'cpo', 'buyer order ref cpo']);
                const wfxIndex = findColumnIndex(poYyHeaders, ['wfx code', 'wfx']);
                const rmColorIndex = findColumnIndex(poYyHeaders, ['rm color code', 'color code', 'rm color']);
                const bulkYyIndex = findColumnIndex(poYyHeaders, ['bulk yy', 'yy', 'yarn yield']);
                const bulkWastageIndex = findColumnIndex(poYyHeaders, ['bulk wastage', 'wastage']);
                
                // Find required columns in MRL Material Details
                const summaryOcIndex = findColumnIndex(mrlHeaders, ['summary oc', 'oc']);
                const articleNameIndex = findColumnIndex(mrlHeaders, ['article name(code)', 'article name', 'article code']);
                const articleColorIndex = findColumnIndex(mrlHeaders, ['article color code', 'color code', 'article color']);
                const consumptionIndex = findColumnIndex(mrlHeaders, ['consumption', 'yy', 'yarn yield']);
                const wastageIndex = findColumnIndex(mrlHeaders, ['wastage %', 'wastage']);
                
                // Validate required columns
                if (vpoIndex === -1 || cpoIndex === -1 || wfxIndex === -1 || rmColorIndex === -1) {
                    showStatus('PO YY file missing required columns. Need: VPO, CPO, WFX Code, RM Color Code', 'error');
                    return;
                }
                
                if (summaryOcIndex === -1 || articleNameIndex === -1 || articleColorIndex === -1) {
                    showStatus('MRL Material Details tab missing required columns. Need: Summary OC, Article Name, Article Color Code', 'error');
                    return;
                }
                
                // Build MRL data map for efficient matching
                const mrlDataMap = new Map();
                let mrlProcessedCount = 0;
                
                for (let i = 1; i < mrlMaterialData.length; i++) {
                    const row = mrlMaterialData[i];
                    if (!row || row.length < Math.max(summaryOcIndex, articleNameIndex, articleColorIndex) + 1) continue;
                    
                    const summaryOc = (row[summaryOcIndex] || '').toString().trim();
                    const articleName = (row[articleNameIndex] || '').toString().trim();
                    const articleColor = (row[articleColorIndex] || '').toString().trim();
                    const consumption = extractYYValue(row[consumptionIndex], `MRL Consumption row ${i}`);
                    const wastage = extractYYValue(row[wastageIndex], `MRL Wastage row ${i}`);
                    
                    if (!summaryOc || !articleName || !articleColor) continue;
                    
                    mrlProcessedCount++;
                    
                    // Extract WFX code from article name
                    const extractedWFX = extractWFXCode(articleName);
                    
                    // Create concatenation key
                    const key = `${summaryOc}_${extractedWFX}_${articleColor}`;
                    
                    mrlDataMap.set(key, {
                        consumption: consumption,
                        wastage: wastage,
                        articleName: articleName,
                        extractedWFX: extractedWFX
                    });
                }
                
                // Process PO YY data using CPO-Based lookup
                validationResults = [];
                let invalidVPOCount = 0;
                let foundOCCount = 0;
                let matchedCount = 0;
                let unmatchedCount = 0;
                
                // Process each PO YY row
                for (let i = 1; i < poYyData.length; i++) {
                    const row = poYyData[i];
                    if (!row || row.length < Math.max(vpoIndex, cpoIndex, wfxIndex, rmColorIndex) + 1) continue;
                    
                    const vpo = (row[vpoIndex] || '').toString().trim();
                    const cpo = (row[cpoIndex] || '').toString().trim(); // Key for CPO-based lookup
                    const wfx = (row[wfxIndex] || '').toString().trim();
                    const rmColor = (row[rmColorIndex] || '').toString().trim();
                    const bulkYy = extractYYValue(row[bulkYyIndex], `PO YY Bulk YY row ${i}`);
                    const bulkWastage = extractYYValue(row[bulkWastageIndex], `PO YY Wastage row ${i}`);
                    
                    if (!vpo || !wfx || !rmColor) continue;
                    
                    // Validate VPO format
                    const isVPOValid = validateVPOFormat(vpo);
                    
                    let finalOC = vpo; // Default to original VPO
                    let foundOC = false;
                    let lookupCPO = '';
                    
                    if (!isVPOValid && cpo && orderDetailsMap.size > 0) {
                        // CPO-Based OC Lookup: Use CPO to find OC number
                        lookupCPO = cpo;
                        const foundOCNumber = findOCFromOrderDetails(cpo);
                        
                        if (foundOCNumber) {
                            finalOC = foundOCNumber;
                            foundOC = true;
                            foundOCCount++;
                        }
                    }
                    
                    const key = `${finalOC}_${wfx}_${rmColor}`;
                    const mrlMatch = mrlDataMap.get(key);
                    
                    let mrlYy = 0;
                    let mrlWastage = 0;
                    let yyMatch = false;
                    let wastageMatch = false;
                    let status = 'Cannot identify summary OC';
                    
                    if (mrlMatch) {
                        mrlYy = mrlMatch.consumption;
                        mrlWastage = mrlMatch.wastage;
                        yyMatch = compareYYValues(bulkYy, mrlYy);
                        wastageMatch = compareWastageValues(bulkWastage, mrlWastage);
                        status = 'Validated';
                        matchedCount++;
                    } else {
                        unmatchedCount++;
                        if (isVPOValid) {
                            status = 'Valid VPO but no MRL match';
                        } else if (foundOC) {
                            status = 'Found OC but no MRL match';
                        }
                    }
                    
                    validationResults.push({
                        summaryCPO: finalOC,
                        wfxCode: wfx,
                        rmColorCode: rmColor,
                        poYyYy: bulkYy,
                        mrlYy: mrlYy,
                        yyMatch: yyMatch,
                        poYyWastage: bulkWastage,
                        mrlWastage: mrlWastage,
                        wastageMatch: wastageMatch,
                        status: status,
                        originalVPO: vpo,
                        lookupCPO: lookupCPO,
                        foundOC: foundOC
                    });
                    
                    if (!isVPOValid && !foundOC) {
                        invalidVPOCount++;
                    }
                }
                
                // Calculate statistics
                const yyMatches = validationResults.filter(r => r.yyMatch).length;
                const yyMismatches = validationResults.filter(r => r.status === 'Validated' && !r.yyMatch).length;
                const wastageMatches = validationResults.filter(r => r.wastageMatch).length;
                const wastageMismatches = validationResults.filter(r => r.status === 'Validated' && !r.wastageMatch).length;
                
                // Update statistics
                updateStatistics(
                    validationResults.length, 
                    yyMatches, 
                    yyMismatches, 
                    wastageMatches, 
                    wastageMismatches, 
                    invalidVPOCount, 
                    foundOCCount
                );
                
                // Show results
                showValidationResults();
                downloadReportBtn.disabled = false;
                
                showStatus(`Validation complete! Processed ${validationResults.length} records. Matched: ${matchedCount}, Unmatched: ${unmatchedCount}. YY: ${yyMatches} matches, ${yyMismatches} mismatches. Found OC numbers: ${foundOCCount}`, 'success');
                
            } catch (error) {
                console.error('Error validating data:', error);
                showStatus('Error validating data. Please check the file formats.', 'error');
            }
        }

        function updateStatistics(total, yyMatches, yyMismatches, wastageMatches, wastageMismatches, invalidVPO, foundOC) {
            document.getElementById('totalRecords').textContent = total;
            document.getElementById('yyMatches').textContent = yyMatches;
            document.getElementById('yyMismatches').textContent = yyMismatches;
            document.getElementById('wastageMatches').textContent = wastageMatches;
            document.getElementById('wastageMismatches').textContent = wastageMismatches;
            document.getElementById('invalidVPO').textContent = invalidVPO;
            document.getElementById('foundOC').textContent = foundOC;
            
            statsSection.style.display = 'grid';
        }

        function showValidationResults() {
            validationSection.style.display = 'block';
            validationTableBody.innerHTML = '';
            
            validationResults.forEach(result => {
                const tr = document.createElement('tr');
                
                // Apply special class for found OC numbers
                const summaryCPOCell = result.foundOC ? 
                    `<td class="found-oc" title="Found OC via CPO lookup: ${result.lookupCPO}">${result.summaryCPO} 🔍</td>` :
                    `<td>${result.summaryCPO}</td>`;
                
                tr.innerHTML = `
                    ${summaryCPOCell}
                    <td>${result.wfxCode}</td>
                    <td>${result.rmColorCode}</td>
                    <td>${formatYYValue(result.poYyYy)}</td>
                    <td>${formatYYValue(result.mrlYy)}</td>
                    <td class="${result.yyMatch ? 'match' : 'mismatch'}">${result.yyMatch ? 'Match' : 'Mismatch'}</td>
                    <td>${result.poYyWastage.toFixed(2)}%</td>
                    <td>${result.mrlWastage.toFixed(2)}%</td>
                    <td class="${result.wastageMatch ? 'match' : 'mismatch'}">${result.wastageMatch ? 'Match' : 'Mismatch'}</td>
                    <td class="${result.status === 'Cannot identify summary OC' ? 'error-status' : 'match'}">
                        ${result.foundOC ? 'Found OC' : result.status}
                    </td>
                    <td>${result.originalVPO || ''}</td>
                    <td>${result.lookupCPO || ''}</td>
                `;
                
                validationTableBody.appendChild(tr);
            });
        }

        function downloadValidationReport() {
            if (validationResults.length === 0) {
                showStatus('No validation data to download.', 'error');
                return;
            }

            try {
                const wb = XLSX.utils.book_new();
                const headers = [
                    'Summary Buyer Order Ref CPO',
                    'WFX Code',
                    'RM Color Code',
                    'PO Wise YY',
                    'MRL YY',
                    'YY Match',
                    'PO Wise Wastage',
                    'MRL Wastage',
                    'Wastage Match',
                    'Status',
                    'Original VPO',
                    'Lookup CPO'
                ];
                
                const data = validationResults.map(item => [
                    item.summaryCPO,
                    item.wfxCode,
                    item.rmColorCode,
                    formatYYValue(item.poYyYy),
                    formatYYValue(item.mrlYy),
                    item.yyMatch ? 'Match' : 'Mismatch',
                    item.poYyWastage.toFixed(2) + '%',
                    item.mrlWastage.toFixed(2) + '%',
                    item.wastageMatch ? 'Match' : 'Mismatch',
                    item.foundOC ? 'Found OC' : item.status,
                    item.originalVPO || '',
                    item.lookupCPO || ''
                ]);
                
                const dataWithHeaders = [headers, ...data];
                const ws = XLSX.utils.aoa_to_sheet(dataWithHeaders);
                
                // Apply color coding based on validation status
                const range = XLSX.utils.decode_range(ws['!ref']);
                
                // Style header row
                for (let C = range.s.c; C <= range.e.c; C++) {
                    const cellRef = XLSX.utils.encode_cell({c: C, r: range.s.r});
                    if (ws[cellRef]) {
                        if (!ws[cellRef].s) ws[cellRef].s = {};
                        ws[cellRef].s.fill = {
                            patternType: "solid",
                            fgColor: { rgb: "34495E" }
                        };
                        ws[cellRef].s.font = { 
                            bold: true, 
                            color: { rgb: "FFFFFF" } 
                        };
                        ws[cellRef].s.alignment = {
                            horizontal: "center"
                        };
                        ws[cellRef].s.border = {
                            top: { style: "thin", color: { rgb: "000000" } },
                            left: { style: "thin", color: { rgb: "000000" } },
                            bottom: { style: "thin", color: { rgb: "000000" } },
                            right: { style: "thin", color: { rgb: "000000" } }
                        };
                    }
                }
                
                // Color data rows based on validation status
                for (let R = range.s.r + 1; R <= range.e.r; R++) {
                    const resultIndex = R - range.s.r - 1;
                    if (resultIndex >= validationResults.length) break;
                    
                    const result = validationResults[resultIndex];
                    const rowColor = getRowColor(result);
                    
                    // Apply color to each cell in the row
                    for (let C = range.s.c; C <= range.e.c; C++) {
                        const cellRef = XLSX.utils.encode_cell({c: C, r: R});
                        if (!ws[cellRef]) continue;
                        
                        if (!ws[cellRef].s) ws[cellRef].s = {};
                        
                        // Set background color
                        ws[cellRef].s.fill = {
                            patternType: "solid",
                            fgColor: { rgb: rowColor }
                        };
                        
                        // Set border
                        ws[cellRef].s.border = {
                            top: { style: "thin", color: { rgb: "000000" } },
                            left: { style: "thin", color: { rgb: "000000" } },
                            bottom: { style: "thin", color: { rgb: "000000" } },
                            right: { style: "thin", color: { rgb: "000000" } }
                        };
                    }
                }
                
                // Set column widths for better readability
                const colWidths = [
                    { wch: 25 }, // Summary Buyer Order Ref CPO
                    { wch: 15 }, // WFX Code
                    { wch: 15 }, // RM Color Code
                    { wch: 12 }, // PO Wise YY
                    { wch: 12 }, // MRL YY
                    { wch: 12 }, // YY Match
                    { wch: 15 }, // PO Wise Wastage
                    { wch: 15 }, // MRL Wastage
                    { wch: 15 }, // Wastage Match
                    { wch: 20 }, // Status
                    { wch: 25 }, // Original VPO
                    { wch: 25 }  // Lookup CPO
                ];
                
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, 'YY & Wastage Validation');
                XLSX.writeFile(wb, 'YY_Wastage_Validation_Report.xlsx');
                
                showStatus('Validation report downloaded successfully with enhanced color coding!', 'success');
            } catch (error) {
                console.error('Error generating validation report:', error);
                showStatus('Error generating validation report.', 'error');
            }
        }

        // Utility function
        function showStatus(message, type) {
            statusDiv.innerHTML = message;
            statusDiv.className = 'status ' + type;
        }
    </script>
</body>
</html>