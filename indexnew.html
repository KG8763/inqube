<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>COE-Home (GitHub Edit)</title>
  <link rel="icon" href="free-30-instagram-stories-icons46_122593.ico" type="image/ico">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    /* --- basic styling --- */
    *{box-sizing:border-box}
    body{font-family:Segoe UI,Roboto,Arial,sans-serif;margin:0;background:linear-gradient(135deg,#10b981,#059669);min-height:100vh;color:#111}
    .header{background:rgba(255,255,255,.95);backdrop-filter:blur(6px);padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000;border-bottom:1px solid rgba(0,0,0,.06)}
    .logo{display:flex;gap:.6rem;align-items:center;font-weight:700;color:#059669}
    .nav{display:flex;gap:.5rem;align-items:center}
    .nav a,.nav button{background:none;border:none;padding:.4rem .7rem;border-radius:6px;text-decoration:none;color:#334155;cursor:pointer;font-weight:600}
    .nav a:hover,.nav button:hover{background:rgba(5,150,105,.06);color:#059669}
    .container{max-width:1300px;margin:1.5rem auto;padding:1rem}
    .title{text-align:center;color:white;margin-bottom:1rem}
    .title h1{font-size:2.4rem;margin:.2rem 0;background:linear-gradient(135deg,#10b981,#059669);-webkit-background-clip:text;color:transparent}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1rem}
    .card{background:rgba(255,255,255,.98);border-radius:14px;padding:1rem;box-shadow:0 8px 30px rgba(0,0,0,.12);position:relative;overflow:hidden}
    .card h3{margin:.2rem 0;color:#0f172a}
    .customers{display:flex;flex-wrap:wrap;gap:.6rem}
    .btn{display:inline-block;padding:.6rem .9rem;border-radius:10px;background:#f1f5f9;color:#0f172a;text-decoration:none;font-weight:700}
    .btn.disabled{background:#e2e8f0;color:#94a3b8;pointer-events:none}
    /* admin edit controls */
    .editable-field{display:block;width:100%;padding:.4rem;border:1px solid #cbd5e1;border-radius:6px;margin-bottom:.4rem}
    .save-area{display:flex;gap:.6rem;align-items:center;justify-content:flex-end;margin:1rem 0}
    .save-btn{background:#059669;color:white;border:none;padding:.6rem 1rem;border-radius:8px;cursor:pointer}
    .save-btn:disabled{opacity:.5;cursor:not-allowed}
    .small{font-size:.9rem;color:#64748b}
    .status-dot{position:absolute;top:10px;right:10px;width:10px;height:10px;border-radius:50%}
    .active-dot{background:#22c55e}
    .disabled-dot{background:#ef4444}
    /* modal */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,.6);z-index:2000;visibility:hidden;opacity:0;transition:all .18s}
    .modal.show{visibility:visible;opacity:1}
    .modal .box{background:white;border-radius:10px;padding:1rem;width:95%;max-width:920px;max-height:85vh;overflow:auto}
    .row{display:flex;gap:.6rem;flex-wrap:wrap}
    label{font-weight:700;color:#0f172a}
    input[type="text"],select,textarea{padding:.5rem;border-radius:6px;border:1px solid #e2e8f0;width:100%}
    .muted{color:#475569;font-size:.9rem}
    footer{padding:1.2rem;text-align:center;color:#e6f7ef}
    @media(max-width:640px){.title h1{font-size:1.6rem}}
  </style>
</head>
<body>
  <header class="header">
    <div class="logo"><i class="fas fa-home"></i> COE-Home</div>
    <nav class="nav">
      <a href="#">MRL-Directions</a>
      <a href="sap.html">SAP</a>
      <a href="huddle.html">Huddle</a>
      <a href="Split_Files_Date_Validator.html">DCL-Split</a>
      <button id="loginBtn" title="Admin login">Admin Login</button>
      <button id="logoutBtn" style="display:none">Logout</button>
    </nav>
  </header>

  <main class="container">
    <section class="title">
      <h1>MRL Guideline Dashboard</h1>
      <p class="small">Access all your customer MRL guidelines and resources in one centralized location</p>
    </section>

    <div class="save-area" id="adminControls" style="display:none">
      <div class="small">Logged in as: <span id="who"></span></div>
      <button class="save-btn" id="commitBtn" disabled>Save & Commit to GitHub</button>
    </div>

    <div id="categories" class="grid"></div>
  </main>

  <div class="modal" id="modal">
    <div class="box">
      <h3 id="modalTitle">Admin Login / Repo Settings</h3>

      <div id="modalContent">
        <div class="row">
          <div style="flex:1">
            <label>GitHub Personal Access Token (PAT)</label>
            <input type="text" id="pat" placeholder="paste token here (not stored server-side)">
            <div class="muted">Token must have repo access (public_repo for public repos). Token stays in browser session only.</div>
          </div>
          <div style="width:260px">
            <label>GitHub Owner (username or org)</label>
            <input type="text" id="owner" placeholder="e.g. your-username-or-org">
          </div>
        </div>

        <div style="height:.6rem"></div>

        <div class="row">
          <div style="flex:1">
            <label>Repository name</label>
            <input type="text" id="repo" placeholder="e.g. my-repo-name">
          </div>
          <div style="width:220px">
            <label>Branch</label>
            <input type="text" id="branch" placeholder="e.g. main">
          </div>
        </div>

        <div style="height:.6rem"></div>

        <div class="row">
          <div style="flex:1">
            <label>Path to customers file</label>
            <input type="text" id="customersPath" placeholder="customers.json (relative to repo root)">
          </div>
          <div style="width:220px">
            <label>Path to changelog</label>
            <input type="text" id="changelogPath" placeholder="changelog.json">
          </div>
        </div>

        <div style="height:.8rem"></div>

        <div style="display:flex;gap:.6rem;justify-content:flex-end">
          <button id="testBtn">Test & Load</button>
          <button id="closeModal">Close</button>
        </div>

        <hr />
        <div class="muted">Instructions: create a GitHub PAT with repository permissions. Paste token above, set owner/repo/branch & file paths, then Test & Load. The token remains only in your browser session (not saved remotely).</div>
      </div>
    </div>
  </div>

  <footer>Built for COE Marketing â€” Edit live content via GitHub API</footer>

<script>
/*
  indexnew.html
  - Client-side GitHub editor:
    * Viewable by anyone (loads repo data via fetch to raw file if no token)
    * Admin enters a PAT and repo config to edit and commit customers.json
    * Changelog appended/updated as changelog.json file
  - NOTE: This requires a GitHub personal access token for editing. See instructions below.
*/

const UI = {
  categoriesEl: document.getElementById('categories'),
  loginBtn: document.getElementById('loginBtn'),
  logoutBtn: document.getElementById('logoutBtn'),
  modal: document.getElementById('modal'),
  testBtn: document.getElementById('testBtn'),
  closeModalBtn: document.getElementById('closeModal'),
  patInput: document.getElementById('pat'),
  ownerInput: document.getElementById('owner'),
  repoInput: document.getElementById('repo'),
  branchInput: document.getElementById('branch'),
  customersPathInput: document.getElementById('customersPath'),
  changelogPathInput: document.getElementById('changelogPath'),
  commitBtn: document.getElementById('commitBtn'),
  adminControls: document.getElementById('adminControls'),
  who: document.getElementById('who')
};

let config = {
  owner: '', repo: '', branch: 'main',
  customersPath: 'customers.json', changelogPath: 'changelog.json'
};
let token = null;
let customersData = null;
let customersSha = null;      // sha of customers.json for updates
let changelogSha = null;      // sha of changelog.json if exists
let loggedInUser = null;
let editable = false;

// --- helper: safe base64 for UTF-8 ---
function utf8_to_b64(str) { return btoa(unescape(encodeURIComponent(str))); }
function b64_to_utf8(b64) { return decodeURIComponent(escape(atob(b64))); }

// --- show/hide modal ---
UI.loginBtn.addEventListener('click', () => {
  UI.modal.classList.add('show');
  // prefill from saved session (if any)
  UI.pat.value = sessionStorage.getItem('gh_pat') || '';
  UI.owner.value = sessionStorage.getItem('gh_owner') || '';
  UI.repo.value = sessionStorage.getItem('gh_repo') || '';
  UI.branch.value = sessionStorage.getItem('gh_branch') || 'main';
  UI.customersPath.value = sessionStorage.getItem('gh_customersPath') || 'customers.json';
  UI.changelogPath.value = sessionStorage.getItem('gh_changelogPath') || 'changelog.json';
});

UI.closeModal.addEventListener('click', () => UI.modal.classList.remove('show'));

// --- Test & Load: will set token/config and try to read files from repo using GitHub API ---
UI.testBtn.addEventListener('click', async () => {
  token = UI.pat.value.trim();
  config.owner = UI.owner.value.trim();
  config.repo = UI.repo.value.trim();
  config.branch = UI.branch.value.trim() || 'main';
  config.customersPath = UI.customersPath.value.trim() || 'customers.json';
  config.changelogPath = UI.changelogPath.value.trim() || 'changelog.json';

  if (!config.owner || !config.repo) return alert('Set owner and repo name.');

  // store in session so admin doesn't retype
  sessionStorage.setItem('gh_pat', token);
  sessionStorage.setItem('gh_owner', config.owner);
  sessionStorage.setItem('gh_repo', config.repo);
  sessionStorage.setItem('gh_branch', config.branch);
  sessionStorage.setItem('gh_customersPath', config.customersPath);
  sessionStorage.setItem('gh_changelogPath', config.changelogPath);

  // If token provided, try to detect user
  if (token) {
    try {
      const me = await ghRequest('GET','https://api.github.com/user');
      loggedInUser = me.login;
      UI.who.textContent = loggedInUser;
      UI.logoutBtn.style.display = 'inline-block';
      UI.loginBtn.style.display = 'none';
      UI.adminControls.style.display = 'flex';
    } catch (err) {
      console.error(err);
      alert('Token seems invalid or network error. Check the console for details.');
      return;
    }
  } else {
    // anonymous
    loggedInUser = null;
    UI.who.textContent = 'anonymous';
    UI.adminControls.style.display = 'none';
  }

  // Fetch customers data from repo using GitHub API - if token given, prefer API; otherwise try raw.githubusercontent
  try {
    await loadCustomersFromRepo();
    renderCategories();
    UI.modal.classList.remove('show');
    alert('Data loaded. If you are logged in, edit controls are available.');
  } catch (e) {
    console.error(e);
    alert('Failed to load customers.json from repo. See console for details.');
  }
});

// logout (clears session token)
UI.logoutBtn.addEventListener('click', () => {
  token = null;
  sessionStorage.removeItem('gh_pat');
  loggedInUser = null;
  UI.logoutBtn.style.display = 'none';
  UI.loginBtn.style.display = 'inline-block';
  UI.adminControls.style.display = 'none';
  UI.who.textContent = '';
  editable = false;
  renderCategories();
});

// commit/save button
UI.commitBtn.addEventListener('click', () => {
  if (!token) return alert('You must login with a PAT to commit.');
  commitChangesToRepo();
});

// --- GitHub request helper (if token present, use Authorization header) ---
async function ghRequest(method, url, body=null) {
  const headers = {'Accept':'application/vnd.github+json'};
  if (token) headers['Authorization'] = 'token ' + token;
  const opts = {method, headers};
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(url, opts);
  if (!res.ok) {
    const txt = await res.text();
    const err = new Error(`GitHub API error ${res.status} ${res.statusText}: ${txt}`);
    err.status = res.status;
    throw err;
  }
  return res.json();
}

// --- loadCustomersFromRepo: uses GitHub API to get file contents (and sha) ---
async function loadCustomersFromRepo() {
  // Attempt: use GitHub Contents API to fetch file content (gives base64 content + sha)
  const path = encodeURIComponent(config.customersPath);
  const url = `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${path}?ref=${encodeURIComponent(config.branch)}`;

  try {
    const data = await ghRequest('GET', url);
    customersSha = data.sha || null;
    const content = b64_to_utf8(data.content.replace(/\n/g,''));
    customersData = JSON.parse(content);
    editable = !!token; // editable only when token present
    UI.commitBtn.disabled = !editable;
    return;
  } catch (err) {
    // if unauthorized or not found, fallback to raw.githubusercontent URL for anonymous GET (read-only)
    console.warn('Contents API failed; trying raw.githubusercontent (anonymous read):', err.message || err);
    const rawUrl = `https://raw.githubusercontent.com/${config.owner}/${config.repo}/${config.branch}/${config.customersPath}`;
    const r = await fetch(rawUrl);
    if (!r.ok) throw new Error('Could not fetch customers.json from raw URL: ' + r.status);
    const txt = await r.text();
    customersData = JSON.parse(txt);
    customersSha = null;
    editable = !!token;
    UI.commitBtn.disabled = !editable;
  }
}

// --- renderCategories: builds DOM. In admin mode shows editable fields. ---
function renderCategories() {
  UI.categoriesEl.innerHTML = '';
  if (!customersData) {
    UI.categoriesEl.innerHTML = '<div class="card">No customers data loaded.</div>';
    return;
  }

  for (const [category, list] of Object.entries(customersData)) {
    const card = document.createElement('div'); card.className = 'card';
    const title = document.createElement('h3'); title.textContent = category; card.appendChild(title);

    const customersDiv = document.createElement('div'); customersDiv.className = 'customers';

    list.forEach((cust, idx) => {
      if (editable) {
        // admin editable card
        const wrapper = document.createElement('div');
        wrapper.style.flex = '1 1 100%';
        wrapper.style.padding = '.4rem 0';
        wrapper.innerHTML = `
          <label class="small">Name</label>
          <input class="editable-field" data-cat="${category}" data-idx="${idx}" data-field="name" value="${escapeHtml(cust.name || '')}">
          <label class="small">File (path)</label>
          <input class="editable-field" data-cat="${category}" data-idx="${idx}" data-field="file" value="${escapeHtml(cust.file || '')}">
          <label class="small">Status</label>
          <select class="editable-field" data-cat="${category}" data-idx="${idx}" data-field="status">
            <option value="active" ${cust.status==='active'?'selected':''}>Active</option>
            <option value="disabled" ${cust.status==='disabled'?'selected':''}>Disabled</option>
          </select>
          <div class="small muted">id: <code>${cust.id || ''}</code></div>
        `;
        // attach onchange handlers
        wrapper.querySelectorAll('[data-field]').forEach(el=>{
          el.addEventListener('change', (e)=>{
            const cat = e.target.dataset.cat;
            const i = Number(e.target.dataset.idx);
            const field = e.target.dataset.field;
            customersData[cat][i][field] = e.target.value;
            UI.commitBtn.disabled = false;
          });
        });
        customersDiv.appendChild(wrapper);
      } else {
        // read-only user view
        const a = document.createElement('a');
        a.className = 'btn';
        a.href = cust.file || '#';
        a.textContent = cust.name || '(no name)';
        if (cust.status === 'disabled') a.classList.add('disabled');
        a.target = '_blank';
        customersDiv.appendChild(a);
      }
    });

    card.appendChild(customersDiv);
    UI.categoriesEl.appendChild(card);
  }

  // admin: enable commit if editable true
  UI.commitBtn.disabled = !editable;
  if (editable) {
    UI.adminControls.style.display = 'flex';
    UI.who.textContent = loggedInUser || 'admin';
  } else {
    UI.adminControls.style.display = 'none';
  }
}

// --- commitChangesToRepo: update customers.json and add an entry to changelog.json ---
async function commitChangesToRepo() {
  if (!token) return alert('Provide PAT and Test & Load first.');
  // prepare updated content
  const contentStr = JSON.stringify(customersData, null, 2);
  const contentB64 = utf8_to_b64(contentStr);

  const path = config.customersPath;
  const url = `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${encodeURIComponent(path)}`;

  // Prepare commit message
  const now = new Date().toISOString();
  const commitMessage = `COE: update customers.json via web UI by ${loggedInUser || 'unknown'} @ ${now}`;

  // Build body - include sha if updating existing file
  const body = {
    message: commitMessage,
    content: contentB64,
    branch: config.branch
  };
  if (customersSha) body.sha = customersSha;

  try {
    const res = await ghRequest('PUT', url, body);
    customersSha = res.content.sha;
    // after successful commit, create/update changelog.json
    await appendChangelogEntry({
      admin: loggedInUser || 'admin',
      time: now,
      action: 'Updated customers.json',
      commit: res.commit ? res.commit.sha : null
    });

    UI.commitBtn.disabled = true;
    alert('customers.json committed successfully.');
  } catch (err) {
    console.error(err);
    alert('Failed to commit customers.json: ' + (err.message || err));
  }
}

// --- appendChangelogEntry: fetch changelog.json, append a new object, commit back ---
async function appendChangelogEntry(entry) {
  // try to get existing changelog
  const path = config.changelogPath;
  const url = `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${encodeURIComponent(path)}`;

  let changelog = [];
  try {
    const data = await ghRequest('GET', url + `?ref=${encodeURIComponent(config.branch)}`);
    changelogSha = data.sha;
    const txt = b64_to_utf8(data.content.replace(/\n/g,''));
    changelog = JSON.parse(txt);
  } catch (err) {
    // if 404 (file not found), we'll create a new changelog
    console.warn('changelog not found; creating new one.');
    changelog = [];
    changelogSha = null;
  }

  changelog.unshift(entry); // push newest first

  // commit new changelog
  const body = {
    message: `COE: update changelog.json by ${loggedInUser || 'admin'} @ ${entry.time}`,
    content: utf8_to_b64(JSON.stringify(changelog, null, 2)),
    branch: config.branch
  };
  if (changelogSha) body.sha = changelogSha;

  const res = await ghRequest('PUT', url, body);
  changelogSha = res.content.sha;
  return res;
}

// --- helpers ---
function escapeHtml(s=''){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

// --- On load: try to load customers.json anonymously from raw.githubusercontent (so page shows fully on first load).
// We attempt raw URL: https://raw.githubusercontent.com/{owner}/{repo}/{branch}/{path}
// But since owner/repo unknown, we will try local customers.json (if present) as fallback (useful for local testing).
(async function init() {
  // try to load a local customers.json first (for local dev when file present in same folder)
  try {
    const r = await fetch('./customers.json');
    if (r.ok) {
      const data = await r.json();
      customersData = data;
      renderCategories();
      return;
    }
  } catch(e) { /* ignore */ }

  // no local file, show placeholder and instruct admin to configure repo.
  UI.categoriesEl.innerHTML = '<div class="card"><h3>Welcome</h3><p class="muted">No local <code>customers.json</code> found. To enable editing via GitHub, click <strong>Admin Login</strong> and enter your repository settings and PAT. Or place a <code>customers.json</code> file in your repo/site root to display content on first load.</p></div>';
})();

</script>

<!-- USAGE & SECURITY NOTE: -->
<!--
  Setup steps for admin:
   1. Create a GitHub Personal Access Token (Settings -> Developer -> Personal access tokens).
      - For a public repo: grant "public_repo".
      - For a private repo: grant "repo" scope.
   2. Open this site (indexnew.html) on GitHub Pages (or locally using a simple server).
   3. Click Admin Login, paste the PAT, set owner (username/org), repo name, branch (main), customers.json path and changelog.json path.
   4. Click Test & Load. If successful you'll be logged in and data will load.
   5. Edit fields and click "Save & Commit to GitHub". This will commit the updated customers.json and changelog.json to the repo branch.

  Security:
   - PAT is only stored in your browser session (sessionStorage). Do NOT paste tokens you don't trust.
   - For team usage, create a dedicated admin PAT with limited scope and rotate it if exposed.
-->

</body>
</html>
