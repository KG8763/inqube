<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOP</title>
    <link rel="icon" href="free-30-instagram-stories-icons46_122593.ico" type="image/ico">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-home"></i> COE-Home
            </div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="index.html" class="nav-link">
                            <i class="fa-solid fa-file-lines"></i> MRL-Directions
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="sap.html" class="nav-link">
                            <i class="fas fa-chart-bar"></i> SAP
                        </a>
                    </li>
                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle">
        <i class="fas fa-users"></i> Huddle
    </a>

    <ul class="dropdown-menu">
        <li>
            <a href="https://inqube.sharepoint.com/sites/COE?market=en-US" target="_blank" class="dropdown-link">
                Huddle - Old
            </a>
        </li>

        <li>
            <a href="https://inqube.sharepoint.com/:x:/r/sites/COE/_layouts/15/Doc.aspx?sourcedoc=%7B2A6A8C12-21BA-40F6-9ABA-A15A024C7C7B%7D&file=Weekly%20Issue%20Log%2025-26.xlsx&action=default&mobileredirect=true&isSPOFile=1&xsdata=MDV8MDJ8fDM5NGJmYjNkY2E0NzQ3MWYxNmRhMDhkZGU2YWMyYjVlfDhiN2JkZTQwNzk5MzQ3MjE5MmE3MWU4NjUwMDllODg4fDB8MHw2Mzg5MjAzNDkyOTI4MzE0NTV8VW5rbm93bnxWR1ZoYlhOVFpXTjFjbWwwZVZObGNuWnBZMlY4ZXlKRFFTSTZJbFJsWVcxelgwRlVVRk5sY25acFkyVmZVMUJQVEU5R0lpd2lWaUk2SWpBdU1DNHdNREF3SWl3aVVDSTZJbGRwYmpNeUlpd2lRVTRpT2lKUGRHaGxjaUlzSWxkVUlqb3hNWDA9fDF8TDJOb1lYUnpMekU1T2pjNU1EZzVaVFkzTFdWaE5EWXROR1kyTUMwNVpXRmtMV1l6TmpCbE5HVTVabUU1WTE5bVlXRXpNVGsxWmkweVltRmxMVFEyTUdVdFltUmxNQzFsT0dNM1pHSXpOemhrTldWQWRXNXhMbWRpYkM1emNHRmpaWE12YldWemMyRm5aWE12TVRjMU5qUXpPREV5TnpVeE5BPT18MDkwNjg0YzI1YmIzNDE2ZTNlZTcwOGRkZTZhYzJiNWR8NmQzNmUzM2MzNWZhNGE0NGJmYzlhMGY2ZjFjMjczODA%3D&sdata=UXdTZVdzcEZwK3IraXNiK1Q2NGcxZEVpVkp2WWZwRFkzQ2pwd1hycmFzWT0%3D&ovuser=8b7bde40-7993-4721-92a7-1e865009e888%2CNisalE%40inqube.com" target="_blank" class="dropdown-link">
                Huddle - New
            </a>
        </li>
    </ul>
</li>

                    <li class="nav-item">
                        <a href="" class="nav-link">
                            <i class="fas fa-building"></i> Customers
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="Split_Files_Date_Validator.html" class="nav-link">
                           <i class="fa-solid fa-explosion"></i> DCL-Split
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="sop.html" class="nav-link">
                            <i class="fas fa-book"></i> SOP

                        </a>
                    </li>
                    <li class="nav-item">
    <a href="coe-performance-dashboard-smf.html" class="nav-link">
        <i class="fa-solid fa-gauge"></i> Dashboard
    </a>
</li>

<li class="nav-item">
    <a href="validations.html" class="nav-link">
        <i class="fa-solid fa-check-double"></i> Validations
    </a>
</li>

                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="dashboard-title">
            <h1>SOP Files Repository</h1>
            <p>Click a file to view</p>
        </div>

        <div class="categories-grid">
            <!-- WFX ERP - BOM -->
            <div class="category-card normal-customers">
                <div class="category-title">
                    <div class="category-icon"><i class="fas fa-users"></i></div>
                    <h2>WFX ERP - BOM</h2>
                </div>
                <div class="customers-grid">
                    <a href="#" class="customer-btn" 
                       data-title="Cost Sheet Creation" 
                       data-docx="SOP_Files/cost-sheet-creation.docx" 
                       data-pdf="SOP_Files/cost-sheet-creation.pdf">
                        Cost Sheet Creation
                        <div class="status-indicator"></div>
                    </a>
                </div>
            </div>

            <!-- WFX ERP - OC -->
            <div class="category-card seamless-customers">
                <div class="category-title">
                    <div class="category-icon"><i class="fas fa-layer-group"></i></div>
                    <h2>WFX ERP - OC</h2>
                </div>
                <div class="customers-grid">
                    <a href="#" class="customer-btn" 
                       data-title="OC Creation" 
                       data-docx="SOP_Files/oc-creation.docx" 
                       data-pdf="SOP_Files/oc-creation.pdf">
                        OC Creation
                        <div class="status-indicator"></div>
                    </a>
                </div>
            </div>

            <!-- SAP ERP -->
            <div class="category-card eb-accounts">
                <div class="category-title">
                    <div class="category-icon"><i class="fas fa-star"></i></div>
                    <h2>SAP ERP</h2>
                </div>
                <div class="customers-grid">
                    <a href="#" class="customer-btn" title="Author: Gihan Alwis"
                       data-title="SAP - BOM Copy" 
                       data-docx="SOP_Files/sap-yy-update.docx" 
                       data-pdf="SOP_Files/sap-yy-update.pdf">
                        SAP - YY Update
                        <div class="status-indicator"></div>
                    </a>
                    <a href="#" class="customer-btn" title="Author: Ruwanthika Nayanahari"
                       data-title="SAP - Auto SO Creation" 
                       data-docx="SOP_Files/sap-auto-so-creation.docx" 
                       data-pdf="SOP_Files/sap-auto-so-creation.pdf">
                        SAP - Auto SO Creation
                        <div class="status-indicator"></div>
                    </a>
                    <a href="#" class="customer-btn" title="Author: Danushka Dissanayake"
                       data-title="SAP - BOM Copy" 
                       data-docx="SOP_Files/sap-bom-copy.docx" 
                       data-pdf="SOP_Files/sap-bom-copy.pdf">
                        SAP - BOM Copy
                        <div class="status-indicator"></div>
                    </a>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div class="modal" id="customerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">SOP File</h3>
                <button class="close-btn" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <iframe class="modal-iframe" src="" frameborder="0"></iframe>
            </div>
            <div class="modal-footer" style="padding:1rem; display:flex; justify-content:flex-end; gap:1rem;">
                <a id="downloadDocx" class="button" download>Download as .docx</a>
                <a id="downloadPdf" class="button" download>Download as .pdf</a>
            </div>
        </div>
    </div>

    <script>
    const modal = document.getElementById('customerModal');
    const modalTitle = document.querySelector('.modal-title');
    const modalIframe = document.querySelector('.modal-iframe');
    const downloadDocx = document.getElementById('downloadDocx');
    const downloadPdf = document.getElementById('downloadPdf');

    // Handle click
    document.querySelectorAll('.customer-btn').forEach(btn => {
        btn.addEventListener('click', async e => {
            e.preventDefault();

            const title = btn.dataset.title;
            const docxFile = btn.dataset.docx;
            const pdfFile = btn.dataset.pdf;

            modalTitle.textContent = title;
            downloadDocx.href = docxFile;
            downloadPdf.href = pdfFile;

            // Try to load the PDF first
            try {
                const res = await fetch(pdfFile);
                if (res.ok) {
                    modalIframe.src = pdfFile;
                } else {
                    console.warn("PDF not found, trying DOCX:", pdfFile);
                    await convertDocxToPdf(docxFile, modalIframe);
                }
            } catch (err) {
                console.warn("Error loading PDF, fallback to DOCX:", err);
                await convertDocxToPdf(docxFile, modalIframe);
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });
    });

    // Close modal
    function closeModal() {
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
        setTimeout(() => {
            modalIframe.src = "";
        }, 300);
    }

    // Click outside to close
    modal.addEventListener('click', e => {
        if (e.target === modal) {
            closeModal();
        }
    });

    // Escape to close
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });

    // Convert DOCX -> PDF and show in iframe
    async function convertDocxToPdf(docxFile, iframe) {
        try {
            const response = await fetch(docxFile);
            if (!response.ok) {
                throw new Error("DOCX file not found: " + response.status);
            }

            const blob = await response.blob();
            console.log("Fetched file type:", blob.type, "size:", blob.size);

            if (!blob.type.includes("wordprocessingml")) {
                throw new Error("Expected DOCX, got: " + blob.type);
            }

            const arrayBuffer = await blob.arrayBuffer();
            const result = await window.mammoth.convertToHtml({ arrayBuffer });
            const htmlContent = result.value;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF("p", "pt", "a4");

            await pdf.html(htmlContent, {
                callback: function (pdf) {
                    const blobUrl = pdf.output("bloburl");
                    iframe.src = blobUrl;
                    downloadPdf.href = blobUrl;
                },
                x: 40,
                y: 40,
            });
        } catch (err) {
            alert("Failed to generate PDF: " + err.message);
            console.error(err);
        }
    }
    </script>
</body>
</html>
